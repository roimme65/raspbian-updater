# Release v1.0.4 - Desktop-Benachrichtigungen

**Veröffentlichungsdatum:** 25. Oktober 2025

## 🔔 Neue Features: Desktop-Benachrichtigungen

Diese Version fügt umfassende Desktop-Benachrichtigungen hinzu, sodass Sie über System-Updates informiert werden - auch wenn diese im Hintergrund via Cronjob laufen.

### Desktop-Benachrichtigungen

**Drei Benachrichtigungstypen:**

#### 🔴 Neustart erforderlich (urgency: critical)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📢 Raspbian Auto-Updater - Neustart erforderlich
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

System-Update abgeschlossen!
6 Paket(e) wurden aktualisiert.

⚠️ Ein Neustart ist erforderlich.
Bitte starten Sie das System neu.
```
- **Icon:** Rotes Warnungs-Symbol
- **Dauer:** Persistent (bleibt sichtbar)
- **Sound:** Warnsignal
- **Use Case:** Kernel-Updates, systemd-Updates

#### 🟢 Update erfolgreich (urgency: normal)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📢 Raspbian Auto-Updater
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

System-Update erfolgreich abgeschlossen!
23 Paket(e) wurden aktualisiert.

✓ Kein Neustart erforderlich.
```
- **Icon:** Grünes Update-Symbol
- **Dauer:** ~10 Sekunden
- **Sound:** Optional
- **Use Case:** Standard-Updates ohne Neustart

#### 🔵 Keine Updates (urgency: low)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📢 Raspbian Auto-Updater
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

System-Update abgeschlossen.

✓ System ist bereits auf dem neuesten Stand.
✓ Keine Updates verfügbar.
```
- **Icon:** Info-Symbol
- **Dauer:** ~5 Sekunden
- **Sound:** Kein
- **Use Case:** Regelmäßige Cronjob-Checks ohne Updates

### Technische Details

**Funktionsweise:**

1. **Automatische User-Erkennung**
   - Nutzt `SUDO_USER` wenn mit sudo ausgeführt
   - Findet DISPLAY und DBUS automatisch aus `/proc/*/environ`
   - Fallback zu Standard-Werten (:0 und /run/user/UID/bus)

2. **Cronjob-kompatibel**
   - Funktioniert auch wenn als root via Cron ausgeführt
   - Benachrichtigt alle aktiven GUI-Sessions
   - Keine Terminal-Interaktion erforderlich

3. **Robuste Fehlerbehandlung**
   - Script läuft normal weiter wenn notify-send fehlt
   - Keine Fehlermeldungen bei fehlender GUI
   - Stille Fehlerbehandlung für maximale Stabilität

**Voraussetzungen (werden automatisch installiert):**
```bash
# Von install.sh automatisch installiert:
- libnotify-bin      # notify-send Kommando
- notification-daemon # Desktop-Notification-Service
```

## 🐛 Bug-Fixes

### Seitlicher Versatz in apt-Ausgabe vollständig behoben

**Problem:** Die Fortschrittsanzeigen von apt und dpkg erzeugten seitlich versetzte Ausgaben wie:
```
(Lese Datenbank ... 5%
                         (Lese Datenbank ... 10%
                                                  (Lese Datenbank ... 15%
```

**Lösung:**
1. **apt -q Option:** Unterdrückt apt-eigene Fortschrittsanzeige
2. **DEBIAN_FRONTEND=noninteractive:** Deaktiviert interaktive Dialoge
3. **-o Dpkg::Use-Pty=0:** Unterdrückt dpkg-Fortschrittsbalken

**Ergebnis:** Saubere, lineare Ausgabe ohne Versatz:
```
Holen:1 http://deb.debian.org/debian trixie InRelease [198 kB]
Holen:2 http://deb.debian.org/debian trixie/main arm64 Packages [9.2 MB]
Es wurden 9.4 MB in 3s geholt (3.1 MB/s)
```

## 📝 Verbesserte Dokumentation

### README.md
- ➕ Neuer Abschnitt "Desktop-Benachrichtigungen"
- 📋 Beispiele für alle drei Benachrichtigungstypen
- 🔧 Erklärung der technischen Funktionsweise

### install.sh
- 📦 Automatische Installation von libnotify-bin
- 📦 Automatische Installation von notification-daemon
- ℹ️ Hinweis für Benutzer über GUI-Funktionalität

## 🔧 Technische Änderungen

### Geänderte Dateien
- `raspbian_autoupdater.py`:
  - Neue Methode `send_desktop_notification()`
  - DEBIAN_FRONTEND=noninteractive für subprocess
  - apt-get mit -q und -o Dpkg::Use-Pty=0 Optionen
  - Benachrichtigungen nach Update-Zusammenfassung

- `install.sh`:
  - Installation von libnotify-bin
  - Installation von notification-daemon
  - **notification-daemon Autostart automatisch eingerichtet**
  - Startet notification-daemon sofort nach Installation
  - Funktioniert nach Neustart automatisch
  - Informative Meldungen für Benutzer

- `uninstall.sh`:
  - Entfernt notification-daemon Autostart-Datei
  - Optional: Deinstalliert libnotify-bin und notification-daemon
  - Stoppt laufende notification-daemon Prozesse

- `README.md`:
  - Version Badge 1.0.4
  - Desktop-Benachrichtigungen Feature-Sektion
  - Installation/Deinstallation Hinweise aktualisiert

- `CHANGELOG.md`:
  - v1.0.4 Einträge hinzugefügt
  - notification-daemon Autostart dokumentiert

### Neue Dateien
- `releases/v1.0.4.md` - Diese Release Notes

## 📦 Installation & Update

### Neue Installation
```bash
git clone https://github.com/roimme65/raspbian-updater.git
cd raspbian-updater
sudo ./install.sh
```

Das install.sh Script installiert jetzt automatisch:
- ✅ libnotify-bin (notify-send Kommando)
- ✅ notification-daemon (Desktop-Benachrichtigungs-Service)
- ✅ **notification-daemon Autostart** (startet automatisch nach Neustart)
- ✅ Alle bestehenden Komponenten

### Update von v1.0.3
```bash
cd raspbian-updater
git pull origin main

# Optional: Benachrichtigungs-Tools nachinstallieren
sudo apt-get install -y libnotify-bin notification-daemon
```

### Deinstallation
```bash
cd raspbian-updater
sudo ./uninstall.sh
```

## 🧪 Testen der Desktop-Benachrichtigungen

### Manueller Test
```bash
# Test-Benachrichtigung senden
notify-send "Test" "Funktioniert die Benachrichtigung?"

# Auto-Updater im Dry-Run testen
sudo raspbian-autoupdater --dry-run
# → Sie sollten eine "Keine Updates" Benachrichtigung sehen
```

### Cronjob-Test
```bash
# Füge Testjob hinzu
echo "*/5 * * * * /usr/local/bin/raspbian-autoupdater" | sudo crontab -

# Warte 5 Minuten, Benachrichtigung sollte erscheinen
# (funktioniert nur wenn GUI-Session aktiv)
```

## 🎯 Use Cases

### Desktop-Benutzer
- ✅ Sichtbare Benachrichtigungen bei manueller oder automatischer Ausführung
- ✅ Kritische Warnungen bei erforderlichem Neustart
- ✅ Feedback auch bei Cronjob-Updates

### Headless-Server
- ✅ Script läuft normal auch ohne Desktop-Umgebung
- ✅ Benachrichtigungen werden übersprungen (keine Fehler)
- ✅ Alle Log-Funktionen bleiben erhalten

### Hybrid (Desktop + SSH)
- ✅ Benachrichtigungen in GUI-Session
- ✅ Log-Dateien für SSH-Zugriff
- ✅ JSON-Status für Automatisierung

## 🐛 Bekannte Probleme

### ~~notification-daemon muss laufen~~ ✅ BEHOBEN in v1.0.4
- ~~**Problem:** Benachrichtigungen erscheinen nur wenn notification-daemon aktiv ist~~
- ~~**Problem:** notification-daemon startet nicht automatisch nach Neustart~~
- **✅ Lösung:** Autostart-Datei wird automatisch von install.sh erstellt
- **✅ Status:** Funktioniert jetzt automatisch nach jedem Neustart

### Benachrichtigungen in Wayland
- **Problem:** notify-send funktioniert möglicherweise nicht unter reinem Wayland
- **Lösung:** Raspberry Pi OS Trixie nutzt X11-Kompatibilitätsschicht
- **Status:** Funktioniert auf Raspberry Pi OS Desktop

## 🙏 Danksagungen

Danke an alle, die Feedback zur Benutzerfreundlichkeit gegeben haben!

## 📊 Statistik

- **Commits:** 3
- **Geänderte Dateien:** 4
- **Neue Zeilen:** ~120
- **Gelöschte Zeilen:** ~40
- **Neue Features:** 1 (Desktop-Benachrichtigungen)
- **Bug-Fixes:** 1 (apt/dpkg Fortschrittsanzeigen)

---

**Vollständiger Changelog:** [CHANGELOG.md](../CHANGELOG.md)  
**Download:** [v1.0.4](https://github.com/roimme65/raspbian-updater/releases/tag/v1.0.4)
