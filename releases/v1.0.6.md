# Release v1.0.6 - Bugfix Release

**Release Date:** 27. Oktober 2025

## 🐛 Behobene Fehler

### Cronjob-Installation funktioniert zuverlässig

Die Cronjob-Installation hatte Probleme mit der Pipe-Konstruktion, die zu leeren Crontabs führte:

**Problem:**
- `(crontab -l | grep -v ...; echo ...) | crontab -` funktionierte nicht zuverlässig
- Cronjobs wurden nicht in die Root-Crontab geschrieben
- Keine Fehlermeldungen bei Problemen

**Lösung:**
- ✅ Verwendung von temporärer Datei `/tmp/raspbian_cron_$$` statt Pipe
- ✅ `|| true` bei grep verhindert Exit-Code-Fehler bei leerer Crontab
- ✅ Prüfung ob Datei Inhalt hat vor crontab-Anwendung (`[ -s "$TEMP_CRON" ]`)
- ✅ Angewendet auf beide Cronjob-Optionen (einzeln und dual)
- ✅ Getestet: Vollständiger Install/Uninstall-Zyklus erfolgreich

**Betroffene Dateien:**
- `install.sh` (Zeilen 186-208, 159-177)

---

### Desktop-Benachrichtigungen in Cronjobs

Desktop-Benachrichtigungen funktionierten nicht, wenn das Skript über Cronjobs ausgeführt wurde:

**Problem:**
- Cron-Umgebung hat keine `DISPLAY` und `DBUS_SESSION_BUS_ADDRESS` Variablen
- notify-send konnte keine Verbindung zum Display herstellen
- Benachrichtigungen blieben aus bei automatischen Updates

**Lösung - 3-Stufen-Erkennung:**

**Methode 1: GUI-Prozess-Suche**
```python
# Sucht nach laufenden GUI-Sessions
- gnome-session
- lxsession  
- wayfire
- xfce4-session
- kde
- mate-session
# Extrahiert DISPLAY und DBUS direkt aus /proc/[pid]/environ
```

**Methode 2: DBUS-Socket-Pfade**
```python
# Prüft Standard-Socket-Verzeichnisse
- /run/user/{uid}/bus
- /var/run/user/{uid}/dbus/user_bus_socket
```

**Methode 3: X11-Socket-Erkennung**
```python
# Fallback zu X11-Sockets
- /tmp/.X11-unix/X0, X1, X2, ...
```

**Zusätzliche Verbesserungen:**
- ✅ XAUTHORITY Umgebungsvariable für X-Authentifizierung
- ✅ Prüfung ob X-Server existiert vor Benachrichtigungs-Versuch
- ✅ Debug-Logging bei Fehlschlägen
- ✅ Funktioniert zuverlässig in Cron-Umgebungen

**Betroffene Dateien:**
- `raspbian_autoupdater.py` (Zeilen 405-540)

---

## 🎨 Verbesserte Ausgabe

### Konsistente Formatierung der Update-Zusammenfassung

**Vorher:**
```
2025-10-27 10:01:21  ✓ Keine Pakete wurden aktualisiert
2025-10-27 10:01:21  
✓ Kein Neustart erforderlich.
2025-10-27 10:01:21  
Log-Datei: /var/log/raspbian-updater/update_20251027_100110.log
```

**Nachher:**
```
2025-10-27 10:03:27  ✓ Keine Pakete wurden aktualisiert (System ist auf dem neuesten Stand)

2025-10-27 10:03:27  ✓ Kein Neustart erforderlich.

2025-10-27 10:03:27  Log-Datei: /var/log/raspbian-updater/update_20251027_100316.log
```

**Änderungen:**
- ✅ Konsistente Timestamps auf allen Status-Zeilen
- ✅ Leerzeilen ohne Timestamps (bessere Lesbarkeit)
- ✅ Saubere Trennung zwischen Zusammenfassungs-Abschnitten
- ✅ Verwendung von `print()` für Leerzeilen statt `\n` in `print_status()`

**Betroffene Dateien:**
- `raspbian_autoupdater.py` (Zeilen 657-659, 689-690)

---

### Vereinfachtes uninstall.sh Banner

**Vorher:**
```
╔══════════════════════════════════════════════════════╗
║   Raspbian Auto-Updater - Deinstallation            ║
║   Version 1.0.4                                      ║
╚══════════════════════════════════════════════════════╝
```

**Nachher:**
```
╔══════════════════════════════════════════════════════╗
║   Raspbian Auto-Updater - Deinstallation            ║
╚══════════════════════════════════════════════════════╝
```

**Grund:** Versionsnummer im Uninstall-Script war verwirrend und wurde oft nicht aktualisiert.

**Betroffene Dateien:**
- `uninstall.sh` (Zeile 17)

---

## 🧪 Tests

Alle Fixes wurden getestet mit:

1. **Cronjob-Test:**
   ```bash
   sudo ./uninstall.sh  # Bereinigung
   sudo ./install.sh    # Installation mit Cronjob-Option 1
   sudo crontab -l      # Verifikation
   ```
   ✅ Cronjob erfolgreich in Root-Crontab erstellt

2. **Desktop-Benachrichtigung-Test:**
   ```bash
   sudo raspbian-autoupdater --dry-run  # Manueller Test
   # Warten auf Cronjob-Ausführung um 3:00 Uhr
   ```
   ✅ Benachrichtigungen erscheinen auch bei Cron-Ausführung

3. **Ausgabe-Test:**
   ```bash
   sudo raspbian-autoupdater
   ```
   ✅ Saubere, konsistente Formatierung in Update-Zusammenfassung

---

## 📦 Installation

```bash
git clone https://github.com/roimme65/raspbian-updater.git
cd raspbian-updater
git checkout v1.0.6
sudo ./install.sh
```

Oder Update von vorheriger Version:

```bash
cd raspbian-updater
git pull
git checkout v1.0.6
sudo ./install.sh  # Aktualisiert Installation
```

---

## 📝 Geänderte Dateien

- `install.sh` - Cronjob-Installation mit temporärer Datei
- `raspbian_autoupdater.py` - Desktop-Benachrichtigungen + Ausgabe-Formatierung
- `uninstall.sh` - Banner ohne Versionsnummer
- `README.md` - Version Badge auf 1.0.6
- `CHANGELOG.md` - Release-Notizen für v1.0.6

---

## 🔗 Links

- **Full Changelog:** https://github.com/roimme65/raspbian-updater/blob/main/CHANGELOG.md#106---2025-10-27
- **Commits:** https://github.com/roimme65/raspbian-updater/compare/v1.0.5...v1.0.6

---

## 📊 Statistiken

- **3 Dateien** geändert
- **154 Zeilen** hinzugefügt/geändert
- **2 kritische Bugs** behoben
- **3 Verbesserungen** implementiert

---

**Download:** [v1.0.6.tar.gz](https://github.com/roimme65/raspbian-updater/archive/refs/tags/v1.0.6.tar.gz) | [v1.0.6.zip](https://github.com/roimme65/raspbian-updater/archive/refs/tags/v1.0.6.zip)
